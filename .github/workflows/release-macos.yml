name: Build and Release macOS Native Host

on:
  push:
    tags:
      - "v*" # Trigger on version tags, e.g. v0.1.0

permissions:
  contents: write

jobs:
  build-macos:
    runs-on: macos-14 # Use M1 runner (Apple Silicon) to build arm64 natively

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install Dependencies
        run: |
          pip install -r requirements.txt
          # Force reinstall binary packages to ensure they match the runner architecture
          pip install --force-reinstall --no-cache-dir tokenizers ctranslate2 faster-whisper
          pip install pyinstaller

      - name: Build with PyInstaller
        run: |
          # Use a simplified build script inline to ensure CI compatibility
          mkdir -p native-host/build
          mkdir -p native-host/dist

          # PyInstaller Command (Cleaned up from your shell script)
          pyinstaller \
            --name video-text-transcriber \
            --windowed \
            --collect-all faster_whisper \
            --collect-all yt_dlp \
            --collect-all opencc \
            --collect-all ctranslate2 \
            --collect-all tokenizers \
            --collect-data mutagen \
            --collect-data brotli \
            --collect-data certifi \
            --collect-data secretstorage \
            --collect-data curl_cffi \
            --hidden-import=ctranslate2.converters.eole_ct2 \
            --hidden-import=faster_whisper.assets \
            --hidden-import=opencc.__main__ \
            --hidden-import=tokenizers.tools \
            --hidden-import=curl_cffi \
            --clean \
            --log-level=INFO \
            --workpath "native-host/build/work" \
            --distpath "native-host/dist" \
            mini_transcriber.py

      - name: Package to ZIP
        run: |
          # Create staging directory
          mkdir -p staging/video-text-transcriber

          # Copy compiled app
          cp -R "native-host/dist/video-text-transcriber" "staging/"

          # Copy helper scripts
          cp "native-host/host-macos.sh" "staging/"
          cp "native-host/host.cjs" "staging/"

          # Create Extension ID file (using a placeholder or passed env var if needed, 
          # for public release usually we leave it empty or direct user to config)
          # Assuming the user installs it via the extension which might have a hardcoded ID?
          # Read Extension ID from file
          EXTENSION_ID=$(cat .github/EXTENSION_ID | tr -d '\n\r ')
          echo "$EXTENSION_ID" > "staging/extension-id.txt"
          echo "Using Extension ID: $EXTENSION_ID"

          # Set permissions
          chmod +x staging/host-macos.sh
          chmod +x staging/video-text-transcriber/video-text-transcriber

          # --- Download and Bundle FFmpeg (macOS ARM64) ---
          echo "Downloading FFmpeg for macOS ARM64..."
          curl -L -o ffmpeg.zip https://www.osxexperts.net/ffmpeg71arm.zip
          unzip -q ffmpeg.zip
          # Finding and moving the binary
          # The zip usually contains "ffmpeg" binary directly or in a folder.
          # We search for it and move it to the same dir as the main executable.
          # We use -name "ffmpeg" and verify it's a file, ignoring permissions initially to be safe.
          FFMPEG_PATH=$(find . -name "ffmpeg" -type f | head -n 1)
          if [ -n "$FFMPEG_PATH" ]; then
            echo "Found ffmpeg at $FFMPEG_PATH"
            chmod +x "$FFMPEG_PATH"
            cp "$FFMPEG_PATH" "staging/video-text-transcriber/ffmpeg"
            chmod +x "staging/video-text-transcriber/ffmpeg"
            echo "FFmpeg bundled successfully."
          else
            echo "ERROR: FFmpeg binary not found in downloaded zip!"
            exit 1
          fi
          # ------------------------------------------------

          # Zip it
          cd staging
          zip -r ../video-text-host-macos.zip .

      - name: Prepare Install/Update Scripts
        run: |
          # Ensure the install script is available as standalone asset
          cp native-host/install_mac.sh install_mac.sh

      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            video-text-host-macos.zip
            install_mac.sh
            native-host/uninstall_mac.sh
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
