#!/usr/bin/env bash
set -euo pipefail

INSTALL_ROOT="${2:-/}"
CONSOLE_USER="$(stat -f%Su /dev/console 2>/dev/null || true)"
USER_HOME="/Users/${CONSOLE_USER}"

if [ -n "${CONSOLE_USER}" ] && [ -d "${INSTALL_ROOT}/Users/${CONSOLE_USER}" ]; then
  USER_HOME="${INSTALL_ROOT}/Users/${CONSOLE_USER}"
elif [ -d "${INSTALL_ROOT}/Library" ]; then
  USER_HOME="${INSTALL_ROOT}"
fi

HOST_DIR="${USER_HOME}/Library/Application Support/VideoTextHost"
PAYLOAD_DIR="${INSTALL_ROOT}/Library/Application Support/VideoTextHost"

mkdir -p "${HOST_DIR}"
if [ -d "${PAYLOAD_DIR}" ]; then
  if [ "${PAYLOAD_DIR}" != "${HOST_DIR}" ]; then
    ditto "${PAYLOAD_DIR}" "${HOST_DIR}"
  fi
fi

if [ -d "${HOST_DIR}/video-text-transcriber" ]; then
  chmod +x "${HOST_DIR}/video-text-transcriber/video-text-transcriber" 2>/dev/null || true
else
  chmod +x "${HOST_DIR}/video-text-transcriber" 2>/dev/null || true
fi
chmod +x "${HOST_DIR}/host-macos.sh" "${HOST_DIR}/host.cjs" 2>/dev/null || true

if command -v xattr >/dev/null 2>&1; then
  xattr -dr com.apple.quarantine "${HOST_DIR}" 2>/dev/null || true
fi

if command -v codesign >/dev/null 2>&1; then
  if [ -d "${HOST_DIR}/video-text-transcriber" ]; then
    codesign --force --deep --sign - "${HOST_DIR}/video-text-transcriber/video-text-transcriber" 2>/dev/null || true
  else
    codesign --force --deep --sign - "${HOST_DIR}/video-text-transcriber" 2>/dev/null || true
  fi
fi

EXTENSION_ID=""
if [ -f "${HOST_DIR}/extension-id.txt" ]; then
  EXTENSION_ID="$(cat "${HOST_DIR}/extension-id.txt")"
fi

if [ -z "${EXTENSION_ID}" ]; then
  exit 0
fi

NATIVE_DIR="${USER_HOME}/Library/Application Support/Google/Chrome/NativeMessagingHosts"
mkdir -p "${NATIVE_DIR}"

cat > "${NATIVE_DIR}/com.video_text.transcriber.json" <<EOF
{
  "name": "com.video_text.transcriber",
  "description": "Video Text Assistant Native Host",
  "path": "${HOST_DIR}/host-macos.sh",
  "type": "stdio",
  "allowed_origins": [
    "chrome-extension://${EXTENSION_ID}/"
  ]
}
EOF

rm -f "${HOST_DIR}/extension-id.txt"
